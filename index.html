<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TypingMeter</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link
      href="https://raw.githubusercontent.com/deddyromnan/TypingMeter/main/assets/css/styles.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <div class="container my-5">
      <div class="row">
        <div class="offset-md-2 col-md-8">
          <h1>Typing Meter</h1>
          <h6>The open source typing speed test</h6>
        </div>
      </div>

      <div class="row">
        <div class="offset-md-2 col-md-8">
          <div class="card my-2">
            <div class="card-body fs-5">
              <div id="paragraph-words"></div>
              <div id="spinner-words" class="text-center">
                <div class="spinner-border" role="status"></div>
              </div>
            </div>
          </div>

          <div class="input-group mb-5">
            <input
              id="input-typed"
              type="text"
              class="form-control form-control-lg"
              autofocus
            />
            <span id="span-timer" class="input-group-text px-4">01:00</span>
            <button
              id="button-restart"
              class="btn btn-success px-4"
              type="button"
            >
              <i class="bi bi-arrow-repeat"></i>
            </button>
          </div>

          <div
            id="card-result"
            class="card visually-hidden"
            style="width: 18rem"
          >
            <div class="card-header">Result</div>
            <div class="card-body">
              <h3
                id="result-wpm"
                class="card-title text-center text-success"
              ></h3>
              <table class="table">
                <tr>
                  <th>Keystrokes</th>
                  <td id="result-keystrokes"></td>
                </tr>
                <tr>
                  <th>Accuracy</th>
                  <td id="result-accuracy"></td>
                </tr>
                <tr>
                  <th>Correct words</th>
                  <td id="result-correct-words"></td>
                </tr>
                <tr>
                  <th>Wrong words</th>
                  <td id="result-wrong-words"></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let started = false;

      let wordsCount = 390;
      let feedCount = 20;

      let timer = null;
      let timeLimit = 59;

      let currentIndex = 0;
      let correctWords = Array();
      let incorrectWords = Array();

      let request = new XMLHttpRequest();
      let requestUrl = "assets/json/english_200.json";
      let response = Array();

      request.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          response = randomWords(JSON.parse(this.responseText).words);
          startTest();
        }
      };
      request.open("GET", requestUrl, true);
      request.send();

      function randomWords(words) {
        let result = Array();
        for (let i = 0; i < wordsCount; i++) {
          let word = words[Math.floor(Math.random() * words.length)];
          result.push(word);
        }
        return result;
      }

      function spanifyWords(words) {
        let result = Array();
        words.forEach((word, i) => {
          result.push(`<span class="word" wordnumber="${i}">${word}</span> `);
        });
        return result;
      }

      function feedWords(startFrom = 0, count = feedCount) {
        let words = spanifyWords(response);
        let wordsSpan = "";
        for (let i = startFrom; i < startFrom + count; i++) {
          wordsSpan += words[i];
        }
        $("#paragraph-words").html(wordsSpan);
        highlightWord(startFrom);
      }

      function restartTest() {
        startTest();
      }

      function endTest() {
        clearInterval(timer);

        $("#input-typed").prop("disabled", true);
        $("#input-typed").val("");
        $("#card-result").removeClass("visually-hidden");

        let correctKeystrokes = 0;
        let incorrectKeystrokes = 0;

        correctWords.forEach((element) => {
          correctKeystrokes += element.length;
        });
        correctKeystrokes += correctWords.length; // add spaces keystrokes

        incorrectWords.forEach((element) => {
          let wrongIndex = element[0];
          let correctAnswer = response[wrongIndex];

          element[1].split("").forEach((letter, i) => {
            if (letter != correctAnswer.charAt(i)) incorrectKeystrokes++;
          });
        });

        let totalKeystrokes = correctKeystrokes + incorrectKeystrokes;
        let accuracy = ((correctKeystrokes / totalKeystrokes) * 100).toFixed(2);

        $("#result-wpm").text(`${correctWords.length} WPM`);
        $("#result-keystrokes").text(
          `(${correctKeystrokes} | ${incorrectKeystrokes}) ${totalKeystrokes}`
        );
        $("#result-accuracy").text(accuracy);
        $("#result-correct-words").text(correctWords.length);
        $("#result-wrong-words").text(incorrectWords.length);
      }

      function startTest() {
        response = randomWords(response);
        started = false;
        currentIndex = 0;
        correctWords = Array();
        incorrectWords = Array();
        feedWords();
        resetTimer();
        $("#spinner-words").addClass("visually-hidden");
        $("#input-typed").prop("disabled", false);
        $("#input-typed").val("");
        $("#input-typed").focus();
      }

      function startTimer() {
        started = true;
        let seconds = timeLimit;
        timer = setInterval(() => {
          if (seconds <= 0) endTest();
          $("#span-timer").text(`00:${seconds < 10 ? "0" : ""}${seconds % 60}`);
          seconds--;
        }, 1000);
      }

      function resetTimer() {
        clearInterval(timer);
        timer = null;
        $("#span-timer").text("01:00");
      }

      function highlightWord(index = 0, color = "bg-secondary") {
        let previousWord = $(`span[wordnumber="${index - 1}"]`);
        previousWord.removeClass(color);

        let currentWord = $(`span[wordnumber="${index}"]`);
        currentWord.removeClass();
        currentWord.addClass("active");
      }

      function setWordColor(index = 0, color = "text-body") {
        let currentWord = $(`span[wordnumber="${index}"]`);
        currentWord.removeClass();
        currentWord.addClass(color);
      }

      $("#button-restart").click(function () {
        restartTest();
      });

      $("#input-typed").keyup(function (event) {
        let typed = $("#input-typed").val();
        let currentWord = $(`span[wordnumber="${currentIndex}"]`).text();
        if (!started && typed.length == 1) startTimer();

        if (event.key == " ") {
          typed = typed.slice(0, typed.length - 1);

          if (typed === currentWord) {
            correctWords.push(typed);
            setWordColor(currentIndex, "text-success");
          } else {
            incorrectWords.push([currentIndex, typed]);
            setWordColor(currentIndex, "text-danger");
          }

          $("#input-typed").val("");
          if (typed.length > 0) currentIndex++;
          if (currentIndex % feedCount == 0) feedWords(currentIndex);
          highlightWord(currentIndex);
        } else {
          currentWord = currentWord.slice(0, typed.length);
          let correct = typed == currentWord;
          highlightWord(currentIndex, correct ? "bg-secondary" : "bg-danger");
        }
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
